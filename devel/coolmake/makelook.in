#!/bin/bash
    : ${RCSID:=$Id: - @VERSION@ @DATE@ @TIME@ - $}
    : ${PROGRAM_TITLE:="Make and get the look of what will be installed"}
    : ${PROGRAM_SYNTAX:="[OPTIONS] [--] ..."}

    . shlib-import cliboot
    option -p --prefix =PATH "Set install prefix, default $prefix"
    option -i --ignores =PATH "Ignored pathnames for treetex, separated by :"
    option -t --treedoc     "Generate complete tree document"
    option -q --quiet       "Repeat to get less info"
    option -v --verbose     "Repeat to get more info"
    option -h --help        "Show this help page"
    option    --version     "Print the version info"

    [ -x "$TREETEX" ]   || TREETEX=`which treetex`
    [ -x "$MAKE" ]      || MAKE=@bindir@/make-color
    [ -x "$MAKE" ]      || MAKE=`which make`

    treetexopts=()
    treetexoptn=0
    prefix=/usr/local
    ignores=

function setopt() {
    case "$1" in
        -p|--prefix)
            prefix="$2";;
        -i|--ignore)
            ignores="$2"
            while [ -n "$ignores" ]; do
                ignore="${ignores%%:*}"
                ignores="${ignores#*:}"
                if [ "$ignore" = "$ignores" ]; then
                    ignores=
                fi
                treetexopts[treetexoptn++]='-i'
                treetexopts[treetexoptn++]="$ignore"
            done
            ;;
        -t|--treedoc)
            treetexopts[treetexoptn++]='-t';;
        -h|--help)
            help; exit;;
        -q|--quiet)
            LOGLEVEL=$((LOGLEVEL - 1));;
        -v|--verbose)
            LOGLEVEL=$((LOGLEVEL + 1));;
        --version)
            version; exit;;
        *)
            quit "invalid option: $1";;
    esac
}

function main() {
    if [ ! -f ./configure ]; then
        _log1 "Generate configure script by autoreconf2"
        autoreconf2 -is
    fi

    if [ -f configure.ac ]; then
        if grep -q AC_CONFIG_HEADER configure.ac; then
            _log1 "Generate config headers"
            autoheader
        fi
    fi

    if [ ! -f Makefile ] && [ -x ./configure ]; then
        _log1 "Generate Makefile by autotools..."
        if ./configure; then
            if [ -f Makefile ]; then
                _log1 "Done."
            else
                _error "./configure success but no Makefile generated. "
                _error "Aborted."
                exit 1
            fi
        else
            _error "No Makefile and do not know how to create it. "
            exit 1
        fi
    fi

    if ! distz=`maketestvar DIST_ARCHIVES`; then
        _error "Failed to get make variable DIST_ARCHIVES. "
        exit 1
    fi

    package_name="${distz%%-[0-9]*}"
    _log1 "The package name: $package_name"

    _log1 "Create distribution tarball: $distz"
    TARZ="tar -a"

    $MAKE -s dist

    if [ $LOGLEVEL -ge 1 ]; then
        echo
        echo "Distribution contents (Re-sorted): "
        $TARZ -tf $distz | LC_COLLATE=C sort
    fi

    tmpdestdir=/tmp/destdir.$$.$RANDOM
    rm -fR $tmpdestdir

    _log1 "Install to temporary destdir $tmpdestdir: "
    if $MAKE -s install DESTDIR=$tmpdestdir prefix="$prefix"; then
        tree -a $tmpdestdir
        if [ -x "$TREETEX" ]; then
            _log1 "Generate install tree in TeX"
            $TREETEX -aF --destdir=$tmpdestdir \
                -c "Files in the package $package_name" \
                -r '\emph{«setupdir»}' \
                "${treetexopts[@]}" $tmpdestdir >itree.tex
        fi
    else
        _error "Failed to install."
    fi

    for f in "$@"; do
        echo "Check file $f: "
        find $tmpdestdir -name $f -exec sh -c "echo In install: {}; cat {} | sed 's/^/> /'; echo" \;
        $TARZ -tf $distz | grep "/$f\$" | xargs -l -I {} \
            sh -c "echo In tarball: {}; $TARZ -xf $distz -O {} | sed 's/^/> /'; echo"
        echo
    done

    _log1 "Cleanup temp destdir."
    rm -fR $tmpdestdir
}

boot "$@"
