#!/bin/bash
# master-file
    . shlib-import cliboot

    RCSID='$Id: - @VERSION@ @DATE@ @TIME@ - $'
    short_opts="p:thqv"
    long_opts="prefix:,treedoc,help,quiet,verbose,version"

    [ -x "$TREETEX" ]   || TREETEX=`which treetex`
    [ -x "$MAKE" ]      || MAKE=@bindir@/make-color
    [ -x "$MAKE" ]      || MAKE=`which make`

    treetexopts=()
    treetexoptn=0
    prefix=/usr/local

function version() {
    parse_id "$RCSID"
    echo "[$BASENAME] Make and get the look of what will be installed"
    echo "Written by Lenik, Version $rcs_rev, Last updated at $rcs_date"
}

function help() {
    version
    echo
    echo "Syntax: "
    echo "    $0 [OPTION] [--] ..."
    echo
    echo "Options: "
    echo "    -p, --prefix=PATH       Set install prefix, default $prefix"
    echo "    -t, --treedoc           Generate complete tree document"
    echo "    -q, --quiet             Repeat to get less info"
    echo "    -v, --verbose           Repeat to get more info"
    echo "    -h, --help              Show this help page"
    echo "        --version           Print the version info"
}

function setopt() {
    case "$1" in
        -p|--prefix)
            prefix="$2";;
        -t|--treedoc)
            treetexopts[treetexoptn++]='-t';;
        -h|--help)
            help; exit;;
        -q|--quiet)
            LOGLEVEL=$((LOGLEVEL - 1));;
        -v|--verbose)
            LOGLEVEL=$((LOGLEVEL + 1));;
        --version)
            version; exit;;
        *)
            quit "invalid option: $1";;
    esac
}

function main() {
    if [ ! -f ./configure ]; then
        _log1 "Generate configure script by autoreconf2"
        autoreconf2 -is
    fi

    if [ ! -f Makefile ] && [ -x ./configure ]; then
        _log1 Generate Makefile by autotools...
        if ./configure; then
            if [ -f Makefile ]; then
                _log1 Done.
            else
                _error "./configure success but no Makefile generated. "
                _error "Aborted."
                exit 1
            fi
        else
            _error "No Makefile and do not know how to create it. "
            exit 1
        fi
    fi

    if ! distz=`maketestvar DIST_ARCHIVES`; then
        _error "Failed to get make variable DIST_ARCHIVES. "
        exit 1
    fi

    package_name="${distz%%-[0-9]*}"
    _log1 "The package name: $package_name"

    _log1 "Create distribution tarball: $distz"
    TARZ="tar -a"

    $MAKE -s dist

    if [ $LOGLEVEL -ge 1 ]; then
        echo
        echo "Distribution contents (Re-sorted): "
        $TARZ -tf $distz | LC_COLLATE=C sort
    fi

    tmpdestdir=/tmp/destdir.$$.$RANDOM
    rm -fR $tmpdestdir

    _log1 "Install to temporary destdir $tmpdestdir: "
    if $MAKE -s install DESTDIR=$tmpdestdir prefix="$prefix"; then
        tree -a $tmpdestdir
        if [ -x "$TREETEX" ]; then
            _log1 "Generate install tree in TeX"
            $TREETEX -aF \
                -c "Files in the package $package_name" \
                -r '\emph{«setupdir»}' \
                "${treetexopts[@]}" $tmpdestdir >itree.tex
        fi
    else
        _error "Failed to install."
    fi

    for f in "$@"; do
        echo "Check file $f: "
        find $tmpdestdir -name $f -exec sh -c "echo In install: {}; cat {} | sed 's/^/> /'; echo" \;
        $TARZ -tf $distz | grep "/$f\$" | xargs -l -I {} \
            sh -c "echo In tarball: {}; $TARZ -xf $distz -O {} | sed 's/^/> /'; echo"
        echo
    done

    _log1 "Cleanup temp destdir."
    rm -fR $tmpdestdir
}

boot "$@"
