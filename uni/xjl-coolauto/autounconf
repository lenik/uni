#!/bin/bash

# bash for: pushd, popd

AUTOUNCONF=`readlink -f $0`
subdirs=
distfiles=

if [ -f Makefile ]; then
    subdirs=`maketestvar SUBDIRS`
    distfiles=`maketestvar DIST_ARCHIVES`
    echo make distclean
    make distclean
fi

AC=configure.ac

for f in COPYING INSTALL install-sh missing; do
    if [ -h $f ]; then
        echo "Remove file by --add-missing: $f"
        rm -f $f
    fi
done

for f in aclocal.m4 configure; do
    if [ -f $f ]; then
        echo "Remove auto-tools generated file: $f"
        rm -f $f
    fi
done

for f in autoscan.log autom4te.cache config.status config.log; do
    if [ -e $f ]; then
        echo "Remove auto-tools cache files: $f"
        rm -fR $f
    fi
done

if [ -f Makefile.am ] && [ -f Makefile.in ]; then
    echo "Remove automake output: Makefile.in"
    rm -f Makefile.in
fi

if [ -f $AC ]; then
    for i in *.in; do
        base="${i%.in}";
        if grep AC_CONFIG_FILES $AC | grep -q "$base"; then
            if [ -f $base ]; then
                echo "Remove config output file: $base"
                rm -f $base
            fi
        fi
    done
fi

if [ -n "$distfiles" ]; then
    for f in $distfiles; do
        echo "Remove dist file: $f"
        rm -f $f
    done
fi

if [ -n "$subdirs" ]; then
    # echo "Subdirs: $subdirs"
    for dir in $subdirs; do
        echo "Recurse into $dir"
        pushd $dir >/dev/null
        $AUTOUNCONF
        popd >/dev/null
    done
fi
