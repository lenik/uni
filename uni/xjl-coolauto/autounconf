#!/bin/bash

# bash for: pushd, popd

RM=sudo_rm

function sudo_rm() {
    local a
    local sudo=0
    for a in "$@"; do
        if [ -e "$a" ] && [ ! -w "$a" ]; then
            sudo=1
        fi
    done

    if [ $sudo = 1 ]; then
        sudo rm -f "$@"
    else
        rm -f "$@"
    fi
}

AUTOUNCONF=`readlink -f $0`
subdirs=
distfiles=
AC=configure.ac

if [ -f Makefile ]; then
    subdirs=`maketestvar SUBDIRS`
    distfiles=`maketestvar DIST_ARCHIVES`
    echo make distclean
    make distclean
fi

compact=0
if [ -h install-sh ] || [ -h missing ]; then
    compact=1
fi

for f in *; do
    if [ -h $f ]; then
        src=`readlink -f $f`
        if [ "$src" != "${src/\/automake-}" ]; then
            echo "Remove file by --add-missing: $f"
            $RM $f
        fi
        if [ "$src" != "${src/\/libauto}" ]; then
            echo "Remove file by xjl-coolauto: $f"
            $RM $f
        fi
    fi
done

if [ $compact = 1 ]; then
    for f in aclocal.m4 configure; do
        if [ -f $f ]; then
            echo "Remove auto-tools generated file: $f"
            $RM $f
        fi
    done
fi

for f in autoscan.log autom4te.cache config.status config.log stamp-h1; do
    if [ -e $f ]; then
        echo "Remove auto-tools cache files: $f"
        $RM -R $f
    fi
done

if [ -f $AC ]; then
    for i in *.in; do
        base="${i%.in}";
        if grep "AC_CONFIG_FILES\|AC_CONFIG_HEADERS" \
            $AC | grep -q "$base"; then
            if [ -f $base ]; then
                echo "Remove config output file: $base"
                $RM $base
            fi
        fi
    done
fi

if [ $compact = 1 ]; then
    if [ -f Makefile.am ] && [ -f Makefile.in ]; then
        echo "Remove automake output: Makefile.in"
        $RM Makefile.in
    fi
fi

if [ -n "$distfiles" ]; then
    for f in $distfiles; do
        echo "Remove dist file: $f"
        $RM $f
    done
fi

if [ -n "$subdirs" ]; then
    # echo "Subdirs: $subdirs"
    for dir in $subdirs; do
        echo "Recurse into $dir"
        pushd $dir >/dev/null
        $AUTOUNCONF
        popd >/dev/null
    done
fi

basename="${PWD##*/}"
if [ -d "debian/$basename" ]; then
    echo "Remove debuild tmp dir: debian/$basename"
    $RM -R "debian/$basename"
fi
