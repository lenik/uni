#!/bin/bash
    : ${RCSID:=$Id: - 0.0.1 2012-11-22 20:52:53 - $}
    : ${PROGRAM_TITLE:=Git-tracked unmerged modified source lines of code}
    : ${PROGRAM_SYNTAX:=[OPTIONS] [--] ...}

    . shlib-import ../shlib.d/rrdwrapper

    dirsfile="${0%.rrw}.dirs"
    colors=(
        '#44B458' '#42A593' '#57738C' '#83A579' '#51859F' '#6156B3' '#917BBB' '#6DA1AE'
        '#616196' '#7D7E8B' '#7A857C' '#4E92B3' '#B0B264' '#A048A5' '#725383' '#AB5C5A'
        '#5F5E56' '#A29756' '#B65DB7' '#736D86' '#8A5DB2' '#A1A176' '#72A35C' '#A16A82'
        '#544B7F' '#A1B5BF' '#469C99' '#63AFBF' '#54B5B3' '#59758D' '#8C749E' '#747CB8'
        '#8E90A9' '#B35470' '#408752' '#797270' '#707493' '#4F51A3' '#469FB6' '#835C91'
        '#A0844F' '#924A59' '#49696D' '#515A96' '#5B6372' '#74A26D' '#AE9062' '#4C697F'
        '#76934A' '#807BA8' '#B78347' '#87844F' '#469970' '#4FB56B' '#5B4A52' '#8A7F6D'
        '#894B82' '#A4476A' '#5F4762' '#A9494A' '#415975' '#426A55' '#42A799' '#83BCB3'
    )

    option    --dirs =PATH  "Specify the .dirs file, default $dirsfile"

    function setopt() {
        case "$1" in
            --dirs)
                dirsfile="$2";;
            *)
                _setopt "$@"
        esac
    }

    boot "$@"

    sample deltas on 1min update
    function deltas_proc() {
        local sum=0
        while IFS=: read project label gitdir; do
            case "$project" in
                '') continue;;
                \#*) continue;;
            esac

            _log2 "Get delta SLOC within $gitdir"
            pushd "$gitdir" >/dev/null
            local delta=`git-delta origin/master`
            echo "d_$project=$delta"
            ((sum += delta))
            popd >/dev/null
        done <"$dirsfile"
        echo "sum=$sum"
    }

    database default \
        on 1min step \
        on 1min make last for 1yr \
        on 10min make average for 1yr

    while IFS=: read project label gitdir; do
        case "$project" in
            '') continue;;
            \#*) continue;;
        esac

        # Max. 10 kLOC before push.
        gauge $project 0:10000 \
            on 2hr timeout \
            on deltas read d_$project

        graph "${project}" "Show modified SLOCs of project $label"

        plot-config \
            -w 750 -h 440 -a PNG \
            --slope-mode \
            --start -14400 --end now \
            --font DEFAULT:7: \
            --title "Unmerged SLOCs of project $label   (Each falling edge could mean a merge)" \
            --watermark "`date`" \
            --vertical-label "SLOC" \
            --right-axis-label "(unmerged)" \
            --lower-limit 0 \
            --right-axis 1:0 \
            --x-grid MINUTE:10:HOUR:1:MINUTE:120:0:%R \
            --alt-y-grid --rigid \

        def delta = $project:LAST
        def mean = $project:AVERAGE

        list trend = '(TREND delta 100)'

        plot trend as line 6px '#FFEEEE'    'Trend ΔSLOC'
        plot mean as line 3px $Pink         'Mean ΔSLOC' # Δ
        plot delta as line 1px $Black       'ΔSLOC'
    done < "$dirsfile"

    gauge sum 0:100000 \
        on 1hr timeout \
        on deltas read sum

    graph "__sum__" "Show total modified SLOCs of all projects"

        plot-config \
            -w 800 -h 440 -a PNG \
            --slope-mode \
            --start -14400 --end now \
            --font DEFAULT:7: \
            --title "Total unmerged SLOCs of all projects   (Each falling edge could mean a merge)" \
            --watermark "`date`" \
            --vertical-label "Σ SLOC" \
            --right-axis-label "(unmerged)" \
            --lower-limit 0 \
            --right-axis 1:0 \
            --x-grid MINUTE:10:HOUR:1:MINUTE:120:0:%R \
            --alt-y-grid --rigid \

        index=0
        while IFS=: read project label gitdir; do
            case "$project" in
                '') continue;;
                \#*) continue;;
            esac

            def delta_$project = $project:LAST
            # def mean_$project = $project:AVERAGE
            plot delta_$project as stacked area ${colors[index++]} "$label ΔSLOC"'\n'
        done < "$dirsfile"

        def delta = sum:LAST
        def mean = sum:AVERAGE

        list trend = '(TREND delta 100)'

        plot trend as line 6px '#FFEEEE'    'Trend Σ ΔSLOC'
        plot mean as line 3px $Pink         'Mean Σ ΔSLOC' # Δ
        plot delta as line 1px $Black       'Σ ΔSLOC'
