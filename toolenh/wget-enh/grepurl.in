#!/bin/bash
    : ${RCSID:=$Id: - @VERSION@ @DATE@ @TIME@ - $}
    : ${PROGRAM_TITLE:="Find urls and join with the start url"}
    : ${PROGRAM_SYNTAX:=[OPTIONS] [--] PATTERN START-URL}
    : ${GREP:=grep}

    . shlib-import cliboot
    option -E --extended-regexp "PATTERN in extended regexp (ERE)"
    option -F --fixed-strings "PATTERN in strings separated by newline"
    option -G --basic-regexp "PATTERN in basic regexp (BRE)"
    option -P --perl-regexp "PATTERN in perl regexp (PRE)"
    option -m --max-count =NUM "max urls to get"
    option -q --quiet       "Repeat to get less info"
    option -v --verbose     "Repeat to get more info"
    option -h --help        "Show this help page"
    option    --version     "Print the version info"

    max_count=

function setopt() {
    case "$1" in
        -E|--extended-regexp)
            GREP="grep -E";;
        -F|--fixed-strings)
            GREP="grep -f";;
        -G|--basic-regexp)
            GREP="grep -G";;
        -P|--perl-regxp)
            GREP="grep -P";;
        -m|--max-count)
            max_count="$2";;
        -h|--help)
            help; exit;;
        -q|--quiet)
            LOGLEVEL=$((LOGLEVEL - 1));;
        -v|--verbose)
            LOGLEVEL=$((LOGLEVEL + 1));;
        --version)
            version; exit;;
        *)
            quit "invalid option: $1";;
    esac
}

function main() {
    if [ -n "$max_count" ]; then
        GREP="$GREP -m $max_count"
    fi

    if [ $# -lt 2 ]; then
        echo "PATTERN and START-URL are required. "
        help
        exit 1
    fi

    pattern="$1"
    url="$2"
    shift 2

    while read match; do
        match="${match#\"}"
        match="${match%\"}"
        urljoin "$url" "$match"
    done < <(wget -qO- "$url" | $GREP -o "\"$pattern\"")
}

boot "$@"
