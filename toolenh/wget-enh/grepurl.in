#!/bin/bash
    : ${RCSID:=$Id: - @VERSION@ @DATE@ @TIME@ - $}
    : ${PROGRAM_TITLE:="Find urls and join with the start url"}
    : ${PROGRAM_SYNTAX:=[OPTIONS] [--] PATTERN START-URL}

    . shlib-import cliboot
    option -E --extended-regexp "Using extended regexp (ERE, default)"
    option -P --perl-regexp     "Using perl regexp (PRE)"
    option -m --max-count =NUM  "max urls to get"
    option -s --strict          "Strict match"
    option -q --quiet           "Repeat to get less info"
    option -v --verbose         "Repeat to get more info"
    option -h --help            "Show this help page"
    option    --version         "Print the version info"

    regexp_type=extended
    grepopts=()
    grepoptn=

    max_count=
    strict=

function setopt() {
    case "$1" in
        -E|--extended-regexp)
            regexp_type=extended
            grepopts[grepoptn++]=-E
            ;;
        -P|--perl-regexp)
            regexp_type=perl
            grepopts[grepoptn++]=-P
            ;;
        -m|--max-count)
            max_count="$2";;
        -s|--strict)
            strict=1;;
        -h|--help)
            help $1; exit;;
        -q|--quiet)
            LOGLEVEL=$((LOGLEVEL - 1));;
        -v|--verbose)
            LOGLEVEL=$((LOGLEVEL + 1));;
        --version)
            version; exit;;
        *)
            quit "invalid option: $1";;
    esac
}

function main() {
    if [ -n "$max_count" ]; then
        grepopts[grepoptn++]='-m'
        grepopts[grepoptn++]="$max_count"
    fi

    if [ $# -lt 2 ]; then
        echo "PATTERN and START-URL are required. "
        help
        exit 1
    fi

    pattern="$1"
    if [ -z "$strict" ]; then
        case "$regexp_type" in
        extended)
            pattern="[^'\"]*$pattern[^'\"]*"
            ;;
        
        perl)
            pattern="[^'\"]*?$pattern[^'\"]*?"
            ;;
        esac
    fi

    url="$2"
    shift 2

    while read match; do
        _log2 "Matched: $match"
        match="${match#\"}"
        match="${match%\"}"
        urljoin "$url" "$match"
    done < <(
        wget -qO- --header='Accept-Encoding:' "$url" \
            | grep "${grepopts[@]}" -o "\"$pattern\"")
}

boot "$@"
