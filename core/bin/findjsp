#!/usr/bin/perl

use strict;
use cmt::util;
use cmt::vcs;
use cmt::path;
use Getopt::Long;
use DirHandle;

sub info;
sub info2;
sub version;
sub help;
sub boot;
sub main;
sub findjsp;
sub lanuch;
sub search_lr;

our $opt_verbtitle      = 'findjsp';
our $opt_verbtime       = 0;
our $opt_verbose        = 1;
our $opt_tomcat_home    = $ENV{CATALINA_HOME} || $ENV{TOMCAT_HOME};
our $opt_editor         = 'notepad';

sub boot {
    GetOptions('quiet|q'    => sub { $opt_verbose-- },
               'verbose|v'  => sub { $opt_verbose++ },
               'version'    => sub { version; exit },
               'help|h'     => sub { help; exit },
	       'tomcat-home=s',
	       'editor=s',
               );
    if (defined $ENV{DIRT_HOME}) {
	my $dirt = $ENV{DIRT_HOME};
	if (-f "$dirt/3/metapad.exe") {
	    $opt_editor = 'metapad';
	}
    }
    info2 "using editor: $opt_editor";
    main;
}

sub info {
    return if $opt_verbose < 1;
    my $text = shift;
    print cdatetime.' ' if $opt_verbtime;
    print "[$opt_verbtitle] $text\n";
}

sub info2 {
    return if $opt_verbose < 2;
    my $text = shift;
    print cdatetime.' ' if $opt_verbtime;
    print "[$opt_verbtitle] $text\n";
}

sub version {
    my %id = parse_id('$Id: findjsp,v 1.4 2007-11-08 10:52:37 lenik Exp $');
    print "[$opt_verbtitle] Perl simple cli program template\n";
    print "Written by Lenik,  Version 0.$id{rev},  Last updated at $id{date}\n";
}

sub help {
    version;
    print <<"EOM";

Syntax:
        $0 <options> ...

Options:
        --quiet (q)
        --verbose (v, repeat twice give you more verbose info)
        --version
        --help (h)
	--tomcat-home=<catalina-home, default env CATALINA_HOME>
	--editor=<edit-program, default notepad>
EOM
}

boot;

sub main {
    if (@ARGV) {
	findjsp for @ARGV;
    } else {
	findjsp while (<>);
    }
}

sub findjsp {
    chomp;
    my $ln = $_;
    if ($ln =~ /^\s* at \s+ (\S+) \((\S+?):(\d+)\).*$/x) {
	my ($class, $file, $lineno) = ($1, $2, $3);
	if ($class =~ s/\._jspService$//) {
	    $class =~ s/\./\\/g;
	    my $search_l = "$opt_tomcat_home/work/Catalina";
	    my $search_r = "$class.java";
	    my @files = search_lr(2, $search_l, $search_r);
	    info2 "find ".scalar(@files)." files\n";
	    for (@files) {
		info "[TOMCAT] $_\n";
		if ($opt_editor eq 'metapad') {
		    $_ =~ s/\//\\/g;
		    launch("$opt_editor /g $lineno:1 $_");
		} else {
		    launch("$opt_editor \"$_\"");
		}
	    }
	} else {
	    print STDERR "Not with-in a jsp-file\n";
	    return -1;
	}
    } else {
	print STDERR "Unknown line: $ln\n";
	return -1;
    }
}

sub launch {
    my $cmdline = shift;
    info2 "launch: $cmdline";
    system($cmdline);
}

sub search_lr {
    my ($depth, $l, $r) = @_;
    info2 "search_lr($depth, $l, $r)";
    my $dl = new DirHandle($l)
	or die("Can't open directory: $l");
    my @fl = grep { !/^\.+$/ } $dl->read;
    my @list;
    if ($depth == 1) {
	for (@fl) {
	    my $l2 = path_join($l, $_);
	    my $term = path_join($l2, $r);
	    push(@list, $term) if (-f $term);
	}
    } else {
	for (@fl) {
	    my $l2 = path_join($l, $_);
	    my @lst2 = search_lr($depth-1, $l2, $r);
	    push @list, @lst2;
	}
    }
    return @list;
}
