#!/lapiota/bin/foreach -x|-o=mode=s

# catname [foreach-options] --mode=MODE files...
# MODE: specify the name-pattern (the prefix may be $ or %)
#       $n  == $cat[n]
#       $$  == $rest
#
# e.g.
#       catname -m $3-$$ *.mpg
#           will rename [aaa][bbb][ccc]rest...mpg to ccc-rest...mpg

use cmt::pp;

die "Mode(-m) isn't specified"
    unless defined $opt_mode;

$file =~ s/\./ /g;

my @cat;
my $rest = $file;

# [...]
while ($file =~ /\[([^\]]+)\]/g) {
    push @cat, $1;
    $rest = substr($file, $+[0]);
}

$file = ppvarf sub { *__ANON__ = '<index-to-part>';
    my $var = shift;
    my $val;
    if ($var =~ /^(\d+)$/) {
        $val = $cat[$1-1];
    } elsif ($var eq '$') {
        $val = $rest;
    }
    return defined $val ? $val : '';
}, $opt_mode;

r
