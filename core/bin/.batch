#!/usr/bin/perl

use strict;
use cmt::path;
use cmt::util;
use cmt::vcs;
use DirHandle;
use Getopt::Long;

sub boot;
sub findfile;
sub dirproc;
sub fileproc;
sub main;

sub mesg;
sub info;
sub info2;
sub version;
sub help;

our $opt_verbtitle      = 'unknown';
our $opt_verbtime       = 0;
our $opt_verbose        = 1;
our $opt_recursive      = 1;
our @opt_and_test       = ();
our @opt_xor_test       = ();
our $opt_dir            = 0;
our $opt_dir_only       = 0;
our $opt_include_hiddens= 0;
our @opt_files          = ();
our $opt_writeback      = 0;

my  $stat_total         = 0;
my  $stat_proc          = 0;

sub boot {
    GetOptions('quiet|q'        => sub { $opt_verbose-- },
               'verbose|v'      => sub { $opt_verbose++ },
               'version'        => sub { version; exit },
               'help|h'         => sub { help; exit },
               'recursive|r'    => sub { $opt_recursive = 100 },
               'and-test|at=s'  => \@opt_and_test,
               'xor-test|xt=s'  => \@opt_and_test,
               'dir|d',
               'dir-only|do',
               'include-hiddens|ih',
               'writeback|w',
               );
    $opt_dir = 1 if $opt_dir_only;

    @opt_files = @ARGV;
    unless (@opt_files) {
        die("No file specified. ");
    }

    @opt_and_test = map \&qg, @opt_and_test;
    @opt_xor_test = map \&qg, @opt_xor_test;

    info2 "--and-test: $_" for @opt_and_test;
    info2 "--xor-test: $_" for @opt_xor_test;
    info2 "file: $_" for @opt_files;

    findfile($_, $opt_recursive) for @opt_files;

    info "Total $stat_proc / $stat_total files processed";

    return $stat_proc;
}

sub mesg {
    return if $opt_verbose < 1;
    my $text = shift;
    print datetime.' ' if $opt_verbtime;
    print "$text";
}

sub info {
    return if $opt_verbose < 1;
    my $text = shift;
    print datetime.' ' if $opt_verbtime;
    print "[$opt_verbtitle] $text\n";
}

sub info2 {
    return if $opt_verbose < 2;
    my $text = shift;
    print datetime.' ' if $opt_verbtime;
    print "[$opt_verbtitle] $text\n";
}

sub version {
    my %id = parse_id('$Id: .batch,v 1.2 2007-07-25 16:14:21 lenik Exp $');
    print "[$opt_verbtitle] Perl simple cli program template\n";
    print "Written by Lenik,  Version $id{rev},  Last updated at $id{date}\n";
}

sub help {
    version;
    print <<"EOM";

Syntax:
        $0 <options> files...

Options:
        --quiet (q)
        --verbose (v, repeat twice give you more verbose info)
        --version
        --help (h)
        --recursive (r)
        --and-test=<pattern> (at, multiple tests are joined by 'or')
        --xor-test=<pattern> (xt, multiple tests are joined by 'or')
        --dir (d)
        --dir-only (do)
        --include-hiddens (ih)
        --writeback (w, default test-only)
EOM
}

exit boot;

sub findfile {
    my ($path, $recur) = @_;
    if (-d $path) {
        dirproc($path) if $opt_dir;
        if ($recur--) {
            my $dh = new DirHandle($path);
            my @files = $dh->read;
            $dh->close;
            for (@files) {
                next if /^\.+$/;
                next if /^\./ and !$opt_include_hiddens;
                my $base = $_;
                my $path2 = "$path/$_";
                if (@opt_and_test) {
                    my @passed = grep { $base =~ $_ } @opt_and_test;
                    next unless @passed;
                }
                if (@opt_xor_test) {
                    my @passed = grep { $base =~ $_ } @opt_xor_test;
                    next if @passed;
                }
                findfile($path2, $recur);
            }
        }
    } else {
        fileproc($path) unless $opt_dir_only;
    }
}

sub dirproc {
    my ($path) = @_;
    mesg "[dir/] $path/\n";
    $stat_total++;
    $stat_proc++ if main @_;
}

sub fileproc {
    my ($path) = @_;
    mesg "[file] $path";
    $stat_total++;
    $stat_proc++ if main @_;
    mesg "\n";
}

sub main {
    my $path = shift;
    if (-f $path) {
        my @in = readfile($path);
        my @out;
        for my $i (0..$#in) {
            $_ = $in[$i];
        }
        if (arrayne(\@in, \@out)) {
            mesg "\r[save] $path";
            writefile($path, @out) if $opt_writeback;
            return 1;
        }
    }
    return 0;
}
