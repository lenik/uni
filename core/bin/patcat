#!/usr/bin/perl

use strict;
use Getopt::Long;
use Data::Dumper;

sub output_summary;
sub output_erase;

my @patches = ();
my $func = \&output_summary;
my $verbose = 0;


GetOptions(
	"summary"			=> sub { $func = \&output_summary },
	"erase"				=> sub { $func = \&output_erase },
	"verbose"			=> \$verbose,
);


# 1, get summaries of all file-unit
	my @block_diff;
	my ($block_name, $in_block);

	while (<>) {
		chop;
		if (m/^Index: (.*)$/) {
			if ($in_block) {
				my $unit = [$block_name, join("\n", @block_diff)];
				push @patches, $unit;
			}
			$in_block = 1;
			$block_name = $1;
			@block_diff = ();
		}

		if ($in_block) {
			next if (m/^\+\+\+/);
			next if (m/^---/);
			push @block_diff, $_ if (m/^[+\-]/);
		}
	}


# 2, sort by diff
	sub by_diff {
		$a->[1] cmp $b->[1];
	}
	@patches = sort by_diff @patches;

	my (@result, @file_list);
	my $last_patch = $patches[0];
	push @file_list, $last_patch->[0];

	my $i;
	for ($i = 1; $i <= $#patches; $i++) {
		my $patch = $patches[$i];
		if ($last_patch->[1] eq $patch->[1]) {
			push @file_list, $patch->[0];
		} else {
			push @result, [[@file_list], $last_patch->[1]];
			$last_patch = $patch;
			@file_list = ($last_patch->[0]);
		}
	}

	if (@file_list) {
		push @result, [[@file_list], $last_patch->[1]];
	}

# 3, sort by diff-count
	sub by_count {
		my @lista = @{$a->[0]};
		my @listb = @{$b->[0]};
		$#listb cmp $#lista;
	}
	@result = sort by_count @result;


# 4, output
	print substr(Dumper(\@result), 8) if $verbose;

	&$func;


#
# SUBROUTINES
#
sub output_summary {
	my $total = 0;
	foreach (@result) {
		my $list = $_->[0];
		my $diff = $_->[1];
		my $files = join("\n\t", @$list);
		my $count = scalar @$list;
		$total += $count;

		print "Patch of following $count files: \n\t$files\n";
		print $diff;
		print "\n\n";
	}

	my $results = scalar @result;
	print "\nTotal $total patches, in $results types. ";
}

sub output_erase {
	print "\@echo off\n";
	foreach (@result) {
		my $list = $_->[0];
		my $diff = $_->[1];
		$diff =~ s/(^|\n)([^\n]?)[ \t]*/${1}rem $2 /g;

		print "rem Patches on following files: \n";
		print "$diff\n";

		foreach (@$list) {
			my $path = $_;
			$path =~ s:/:\\:g;
			print "echo Remove $path ...\n";
			print "del \"$path\"\n";
		}

		print "\n";
	}
}
